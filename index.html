<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Table Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/default.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        th[contenteditable="true"], td[contenteditable="true"] {
            outline: none;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .selected-row {
            background-color: #d1e7dd !important;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button, .styled-input-file {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover, .styled-input-file:hover {
            background-color: #0056b3;
        }
        .styled-input-file {
            display: inline-block;
            position: relative;
        }
        .styled-input-file input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
        }
        .context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
        }
        .context-menu button {
            display: block;
            width: 100%;
            border: none;
            background: none;
            text-align: left;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            color: black;
        }
        .context-menu button:hover {
            background-color: #f0f0f0;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 10px;
            background-color: #f2f2f2;
            border: 1px solid #ccc;
            border-radius: 4px;
            height: 400px;
            overflow: auto;
        }
        #loader {
            display: none;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #progressMessage {
            text-align: center;
            margin-top: 20px;
        }
        .highlight-button {
            background-color: #28a745;
        }
        .highlight-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <h1>JSON Table Editor</h1>
    <div class="button-group">
        <label class="styled-input-file">
            Upload JSON
            <input type="file" id="fileInput" />
        </label>
        <button id="viewTableButton" onclick="viewAsTable()" style="display: none;">View as Table</button>
    </div>
    <br><br>
    <div id="loader"></div>
    <div id="progressMessage"></div>
    <br>
    <table id="jsonTable" style="display: none;">
        <thead>
            <tr id="headerRow"></tr>
        </thead>
        <tbody id="jsonTableBody"></tbody>
    </table>
    <div class="button-group">
        <button onclick="updateJSON()" class="highlight-button">Update JSON</button>
        <button id="copyJsonButton" onclick="copyJSON()" class="highlight-button" style="display: none;">Copy JSON</button>
    </div>
    <br><br>
    <pre id="jsonOutput" class="json-output"></pre>
    
    <div id="contextMenu" class="context-menu">
        <button onclick="insertRowAbove()">Insert Row Above</button>
        <button onclick="insertRowBelow()">Insert Row Below</button>
        <button onclick="deleteCurrentRow()">Delete Current Row</button>
    </div>
    <div id="headerContextMenu" class="context-menu">
        <button onclick="insertColumnLeft()">Insert Column Left</button>
        <button onclick="insertColumnRight()">Insert Column Right</button>
        <button onclick="deleteCurrentColumn()">Delete Current Column</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/json.min.js"></script>
    <script>
        let workbook = {
            "WorkbookName": "MyWorkbook",
            "Sheets": [
                {
                    "SheetName": "Sheet1",
                    "Rows": [
                        {"A": "John", "B": 30, "C": "New York"},
                        {"A": "Anna", "B": 22, "C": "London"},
                        {"A": "Mike", "B": 32, "C": "Chicago"}
                    ]
                },
                {
                    "SheetName": "Sheet2",
                    "Rows": [
                        {"A": "Product", "B": "Price", "C": "Quantity"},
                        {"A": "Apple", "B": 1.2, "C": 10},
                        {"A": "Banana", "B": 0.8, "C": 5},
                        {"A": "Cherry", "B": 2.5, "C": 20}
                    ]
                }
            ]
        };

        if (localStorage.getItem('workbook')) {
            workbook = JSON.parse(localStorage.getItem('workbook'));
        }

        let currentSheetIndex = 0;
        let contextMenuRowIndex = null;
        let contextMenuColumnIndex = null;
        let selectedRowIndex = null;

        document.getElementById('fileInput').addEventListener('change', function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const json = event.target.result;
                    workbook = JSON.parse(json);
                    localStorage.setItem('workbook', JSON.stringify(workbook));
                    document.getElementById('viewTableButton').style.display = 'inline-block';
                };
                reader.readAsText(file);
            }
        });

        function createTableFromJSON() {
            const sheet = workbook.Sheets[currentSheetIndex];
            const table = document.getElementById('jsonTable');
            const headerRow = document.getElementById('headerRow');
            const tableBody = document.getElementById('jsonTableBody');

            // Clear the table
            headerRow.innerHTML = '';
            tableBody.innerHTML = '';

            if (!sheet.Rows.length) return;

            // Create header
            const keys = Object.keys(sheet.Rows[0]);
            keys.forEach((key, index) => {
                const th = document.createElement('th');
                th.contentEditable = true;
                th.innerText = key;
                th.dataset.index = index;
                th.addEventListener('contextmenu', (event) => showHeaderContextMenu(event, index));
                th.addEventListener('blur', updateHeader);
                headerRow.appendChild(th);
            });

            // Create rows
            sheet.Rows.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.dataset.rowIndex = rowIndex;
                tr.addEventListener('contextmenu', (event) => showContextMenu(event, rowIndex));
                tr.addEventListener('click', () => selectRow(rowIndex));
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.contentEditable = true;
                    td.innerText = row[key];
                    td.dataset.row = rowIndex;
                    td.dataset.key = key;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        function selectRow(rowIndex) {
            if (selectedRowIndex !== null) {
                document.querySelector(`tr[data-row-index="${selectedRowIndex}"]`).classList.remove('selected-row');
            }
            selectedRowIndex = rowIndex;
            document.querySelector(`tr[data-row-index="${rowIndex}"]`).classList.add('selected-row');
        }

        function deleteCurrentRow() {
            if (contextMenuRowIndex !== null) {
                const sheet = workbook.Sheets[currentSheetIndex];
                sheet.Rows.splice(contextMenuRowIndex, 1);
                createTableFromJSON();
                contextMenuRowIndex = null;
            }
        }

        function deleteCurrentColumn() {
            if (contextMenuColumnIndex !== null) {
                const sheet = workbook.Sheets[currentSheetIndex];
                const keys = Object.keys(sheet.Rows[0]);
                const keyToDelete = keys[contextMenuColumnIndex];
                sheet.Rows.forEach(row => delete row[keyToDelete]);
                createTableFromJSON();
                contextMenuColumnIndex = null;
            }
        }

        function updateHeader(event) {
            const newKey = event.target.innerText.trim();
            const headerIndex = event.target.dataset.index;
            const sheet = workbook.Sheets[currentSheetIndex];
            const oldKey = Object.keys(sheet.Rows[0])[headerIndex];

            if (newKey && newKey !== oldKey) {
                sheet.Rows.forEach(row => {
                    Object.defineProperty(row, newKey,
                        Object.getOwnPropertyDescriptor(row, oldKey));
                    delete row[oldKey];
                });
                createTableFromJSON();
            }
        }

        function updateCurrentSheetData() {
            const sheet = workbook.Sheets[currentSheetIndex];
            const tableBody = document.getElementById('jsonTableBody');
            const rows = tableBody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                for (let j = 0; j < cells.length; j++) {
                    const cell = cells[j];
                    const rowIndex = cell.dataset.row;
                    const key = cell.dataset.key;
                    sheet.Rows[rowIndex][key] = cell.innerText.trim() === '' ? '' : cell.innerText;
                }
            }
        }

        function updateJSON() {
            updateCurrentSheetData();
            localStorage.setItem('workbook', JSON.stringify(workbook));
            const jsonOutput = document.getElementById('jsonOutput');
            jsonOutput.textContent = JSON.stringify(workbook, null, 2);
            hljs.highlightBlock(jsonOutput);
            document.getElementById('copyJsonButton').style.display = 'inline-block';
        }

        function copyJSON() {
            const jsonOutput = document.getElementById('jsonOutput');
            const range = document.createRange();
            range.selectNodeContents(jsonOutput);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand("copy");
            alert("Copied the JSON to clipboard");
        }

        function showContextMenu(event, rowIndex) {
            event.preventDefault();
            contextMenuRowIndex = rowIndex;

            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${event.pageX}px`;
            contextMenu.style.top = `${event.pageY}px`;

            document.addEventListener('click', hideContextMenu);
        }

        function hideContextMenu() {
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'none';
            const headerContextMenu = document.getElementById('headerContextMenu');
            headerContextMenu.style.display = 'none';
            document.removeEventListener('click', hideContextMenu);
        }

        function showHeaderContextMenu(event, columnIndex) {
            event.preventDefault();
            contextMenuColumnIndex = columnIndex;

            const headerContextMenu = document.getElementById('headerContextMenu');
            headerContextMenu.style.display = 'block';
            headerContextMenu.style.left = `${event.pageX}px`;
            headerContextMenu.style.top = `${event.pageY}px`;

            document.addEventListener('click', hideContextMenu);
        }

        function insertRowAbove() {
            const sheet = workbook.Sheets[currentSheetIndex];
            const newRow = {};
            const keys = Object.keys(sheet.Rows[0]);
            keys.forEach(key => newRow[key] = '');
            sheet.Rows.splice(contextMenuRowIndex, 0, newRow);
            createTableFromJSON();
            hideContextMenu();
        }

        function insertRowBelow() {
            const sheet = workbook.Sheets[currentSheetIndex];
            const newRow = {};
            const keys = Object.keys(sheet.Rows[0]);
            keys.forEach(key => newRow[key] = '');
            sheet.Rows.splice(contextMenuRowIndex + 1, 0, newRow);
            createTableFromJSON();
            hideContextMenu();
        }

        function insertColumnLeft() {
            const sheet = workbook.Sheets[currentSheetIndex];
            const keys = Object.keys(sheet.Rows[0]);
            const newKey = prompt("Enter the name for the new column:");
            if (newKey) {
                sheet.Rows.forEach(row => {
                    const updatedRow = {};
                    keys.forEach((key, index) => {
                        if (index === contextMenuColumnIndex) {
                            updatedRow[newKey] = '';
                        }
                        updatedRow[key] = row[key];
                    });
                    Object.assign(row, updatedRow);
                });
                createTableFromJSON();
            }
        }

        function insertColumnRight() {
            const sheet = workbook.Sheets[currentSheetIndex];
            const keys = Object.keys(sheet.Rows[0]);
            const newKey = prompt("Enter the name for the new column:");
            if (newKey) {
                sheet.Rows.forEach(row => {
                    const updatedRow = {};
                    keys.forEach((key, index) => {
                        updatedRow[key] = row[key];
                        if (index === contextMenuColumnIndex) {
                            updatedRow[newKey] = '';
                        }
                    });
                    Object.assign(row, updatedRow);
                });
                createTableFromJSON();
            }
        }

        function viewAsTable() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('progressMessage').innerText = 'Rendering table, please wait...';
            setTimeout(() => {
                createTableFromJSON();
                updateJSON();
                document.getElementById('loader').style.display = 'none';
                document.getElementById('progressMessage').innerText = '';
                document.getElementById('jsonTable').style.display = 'table';
            }, 500); // Simulate a delay for the loader
        }

        window.onload = () => {
            createTableFromJSON();
            updateJSON();
        }
    </script>
</body>
</html>
